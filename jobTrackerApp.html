<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Application Kanban Board</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }
        #sidebar {
            background-color: #2d3748;
            color: #a0aec0;
            padding: 1.5rem 1rem;
            width: 240px;
            flex-shrink: 0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            transition: width 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        #sidebar.collapsed {
            width: 80px;
            padding: 1.5rem 0.5rem;
        }
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #4a5568;
        }
        #sidebar h2 .sidebar-title-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: #e2e8f0;
            transition: opacity 0.3s ease-in-out, max-width 0.3s ease-in-out;
            display: inline-block;
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            vertical-align: middle;
        }
        #sidebar.collapsed h2 .sidebar-title-text { opacity: 0; max-width: 0; }
        #sidebar h2 i { font-size: 1.5rem; color: #e2e8f0; margin-right: 0.5rem; vertical-align: middle; }
        #sidebarToggleBtn { color: #a0aec0; background: transparent; border: none; padding: 0.5rem; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        #sidebarToggleBtn:hover { background-color: #4a5568; color: #ffffff; }
        #sidebarToggleBtn i { transition: transform 0.3s ease-in-out; }
        #sidebar.collapsed #sidebarToggleBtn i { transform: rotate(180deg); }
        #sidebar ul { list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto; }
        #sidebar ul li a { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.375rem; text-decoration: none; color: #a0aec0; transition: background-color 0.2s, color 0.2s; margin-bottom: 0.5rem; white-space: nowrap; overflow: hidden; cursor:pointer; }
        #sidebar.collapsed ul li a { padding: 0.75rem; justify-content: center; }
        #sidebar ul li a:hover, #sidebar ul li a.active { background-color: #4a5568; color: #ffffff; }
        #sidebar ul li a i { margin-right: 0.75rem; width: 20px; text-align: center; flex-shrink: 0; transition: margin-right 0.3s ease-in-out; }
        #sidebar.collapsed ul li a i { margin-right: 0; }
        .sidebar-link-text { opacity: 1; transition: opacity 0.2s ease-in-out 0.1s, max-width 0.3s ease-in-out; max-width: 150px; overflow: hidden; display: inline-block; }
        #sidebar.collapsed .sidebar-link-text { opacity: 0; max-width: 0; }

        #main-content { flex-grow: 1; padding: 1rem 2rem; overflow-y: auto; display: flex; flex-direction: column; transition: margin-left 0.3s ease-in-out; }
        .page-section { display: none; }
        .page-section.active { display: flex; flex-direction: column; flex-grow: 1; }

        .kanban-column { min-height: 300px; background-color: #2d3748; border-radius: 0.5rem; padding: 1rem; margin: 0.5rem; flex: 1; min-width: 280px; }
        .kanban-card { background-color: #4a5568; border-radius: 0.375rem; padding: 1rem; margin-bottom: 1rem; cursor: pointer; transition: background-color 0.2s, transform 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .kanban-card:hover { background-color: #5a6678; transform: translateY(-2px); }
        .modal { background-color: rgba(0, 0, 0, 0.7); }
        .modal-content { background-color: #2d3748; color: #e2e8f0; }
        .modal-input, .modal-textarea, .modal-select, .page-select, .search-input, .config-input {
            background-color: #4a5568; border: 1px solid #718096; color: #e2e8f0;
            border-radius: 0.25rem; padding: 0.75rem; width: 100%;
        }
        .modal-input:focus, .modal-textarea:focus, .modal-select:focus, .page-select:focus, .search-input:focus, .config-input:focus {
            outline: none; border-color: #63b3ed; box-shadow: 0 0 0 2px rgba(99, 179, 237, 0.5);
        }
        .btn-primary { background-color: #4299e1; color: white; padding: 0.5rem 1rem; border-radius: 0.25rem; font-weight: bold; }
        .btn-primary:hover { background-color: #3182ce; }
        .btn-secondary { background-color: #718096; color: white; padding: 0.5rem 1rem; border-radius: 0.25rem; }
        .btn-secondary:hover { background-color: #4a5568; }
        .dragging { opacity: 0.5; border: 2px dashed #cbd5e0; transform: rotate(3deg); }
        .drag-over-column { background-color: #424c5e; border: 2px dashed #63b3ed; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a202c; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }

        .studio-textarea {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            background-color: #1a202c; border: 1px solid #4a5568; color: #e2e8f0;
            border-radius: 0.25rem; padding: 0.75rem; min-height: 200px; resize: vertical;
        }
        .studio-textarea:focus { outline: none; border-color: #63b3ed; box-shadow: 0 0 0 2px rgba(99, 179, 237, 0.5); }
        .field-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .field-header label { font-weight: 600; color: #a0aec0; font-size: 1.1rem; }
        .btn-clear { background-color: transparent; color: #a0aec0; border: 1px solid #4a5568; padding: 0.25rem 0.5rem; font-size: 0.75rem; border-radius: 0.25rem; }
        .btn-clear:hover { background-color: #4a5568; color: #ffffff; }
        .feedback-output-container, .research-output-container {
            margin-top: 1.5rem; padding: 1.25rem; background-color: #161b25;
            border: 1px solid #4a5568; border-radius: 0.375rem; box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }
        .feedback-output-container h4, .research-output-container h4 { font-weight: 600; color: #90cdf4; margin-bottom: 0.75rem; font-size: 1.1rem; }
        .feedback-output-container pre, .research-output-container pre {
            white-space: pre-wrap; word-wrap: break-word; font-family: 'Inter', sans-serif;
            font-size: 0.9rem; color: #cdd5e0; line-height: 1.6;
        }
        .studio-section, .settings-section, .dashboard-section {
            background-color: #2d3748; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        #jobSelectionContainer { margin-bottom: 1.5rem; }
        .llm-config-section label { font-size: 0.9rem; color: #a0aec0; margin-bottom: 0.25rem; display: block;}

        .stat-card {
            background-color: #4a5568; padding: 1.5rem; border-radius: 0.5rem;
            text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
        }
        .stat-card-value { font-size: 2.5rem; font-weight: 700; color: #ffffff; line-height: 1; }
        .stat-card-label { font-size: 0.875rem; color: #a0aec0; margin-top: 0.5rem; }

        /* Follow-up List Styles */
        .follow-up-list { list-style: none; padding: 0; }
        .follow-up-item {
            background-color: #4a5568;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }
        .follow-up-item:hover { background-color: #5a6678; }
        .follow-up-item-info .title { font-weight: 600; color: #e2e8f0; }
        .follow-up-item-info .company { font-size: 0.875rem; color: #a0aec0; }
        .follow-up-item-date { font-size: 0.875rem; color: #cbd5e0; font-weight: 500; }
        .follow-up-item-date.overdue { color: #f56565; /* Red for overdue */ font-weight: bold; }
        .follow-up-item-date.today { color: #68d391; /* Green for today */ font-weight: bold; }

        body.light-mode {
            background-color: #f3f4f6; /* gray-100 */
            color: #1a202c; /* gray-800 */
        }
        body.light-mode #sidebar {
            background-color: #e5e7eb; /* gray-200 */
            color: #1a202c;
            box-shadow: 2px 0 5px rgba(0,0,0,0.07);
            border-right: 1px solid #d1d5db; /* gray-300 */
        }
        body.light-mode #sidebar h2 .sidebar-title-text,
        body.light-mode #sidebar h2 i {
            color: #1a202c;
        }
        body.light-mode #sidebar ul li a {
            color: #1a202c;
        }
        body.light-mode #sidebar ul li a:hover, body.light-mode #sidebar ul li a.active {
            background-color: #d1d5db; /* gray-300 */
            color: #111827;
        }
        body.light-mode .kanban-column {
            background-color: #f9fafb; /* gray-50 */
            border: 1px solid #d1d5db; /* gray-300 */
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border-radius: 0.5rem;
        }
        body.light-mode .kanban-column h3 {
            background-color: #e5e7eb; /* gray-200 */
            color: #1a202c; /* gray-800 */
            font-weight: 700;
            border-radius: 0.5rem 0.5rem 0 0;
            padding: 0.75rem 1rem;
            margin: -1rem -1rem 1rem -1rem;
            border-bottom: 1px solid #d1d5db;
        }
        body.light-mode .kanban-card {
            background-color: #fff;
            color: #1a202c;
            border: 1px solid #d1d5db;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border-radius: 0.375rem;
        }
        body.light-mode .kanban-card:hover {
            background-color: #f3f4f6; /* gray-100 */
        }
        body.light-mode .kanban-card h4 {
            color: #1a202c;
        }
        body.light-mode .kanban-card p {
            color: #374151; /* gray-700 */
        }
        body.light-mode .modal-content,
        body.light-mode .studio-section,
        body.light-mode .settings-section,
        body.light-mode .dashboard-section {
            background-color: #f9fafb; /* gray-50 */
            color: #1a202c;
            border: 1px solid #d1d5db; /* gray-300 */
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }
        body.light-mode .modal-input, body.light-mode .modal-textarea, body.light-mode .modal-select, body.light-mode .page-select, body.light-mode .search-input, body.light-mode .config-input {
            background-color: #f3f4f6; /* gray-100 */
            border: 1px solid #d1d5db; /* gray-300 */
            color: #1a202c;
        }
        body.light-mode .modal-input:focus, body.light-mode .modal-textarea:focus, body.light-mode .modal-select:focus, body.light-mode .page-select:focus, body.light-mode .search-input:focus, body.light-mode .config-input:focus {
            border-color: #4299e1;
            box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.15);
        }
        body.light-mode .stat-card {
            background-color: #e5e7eb; /* gray-200 */
            color: #1a202c;
            border: 1px solid #d1d5db; /* gray-300 */
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }
        body.light-mode .feedback-output-container, body.light-mode .research-output-container {
            background-color: #f3f4f6; /* gray-100 */
            border: 1px solid #d1d5db; /* gray-300 */
            color: #1a202c;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }
        body.light-mode .follow-up-item {
            background-color: #e5e7eb; /* gray-200 */
            color: #1a202c;
            border: 1px solid #d1d5db; /* gray-300 */
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }
        body.light-mode .follow-up-item:hover {
            background-color: #f3f4f6; /* gray-100 */
        }
        body.light-mode .follow-up-item-info .title {
            color: #1a202c;
        }
        body.light-mode .follow-up-item-info .company {
            color: #374151; /* gray-700 */
        }
        body.light-mode .follow-up-item-date {
            color: #1a202c;
        }
        body.light-mode .follow-up-item-date.overdue {
            color: #e53e3e;
        }
        body.light-mode .follow-up-item-date.today {
            color: #38a169;
        }
        body.light-mode ::-webkit-scrollbar-track {
            background: #f3f4f6;
        }
        body.light-mode ::-webkit-scrollbar-thumb {
            background: #d1d5db;
        }
        body.light-mode .btn-primary {
            background-color: #4299e1;
            color: #fff;
        }
        body.light-mode .btn-primary:hover {
            background-color: #3182ce;
        }
        body.light-mode .btn-secondary {
            background-color: #a0aec0;
            color: #1a202c;
        }
        body.light-mode .btn-secondary:hover {
            background-color: #d1d5db;
        }
        body.light-mode .studio-textarea {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            color: #1a202c;
        }
        body.light-mode .studio-textarea:focus {
            border-color: #4299e1;
            box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.15);
        }
        body.light-mode .border-blue-400 { border-color: #60a5fa !important; }
        body.light-mode .border-indigo-400 { border-color: #818cf8 !important; }
        body.light-mode .border-yellow-400 { border-color: #facc15 !important; }
        body.light-mode .border-green-400 { border-color: #4ade80 !important; }
        body.light-mode .border-red-400 { border-color: #f87171 !important; }
        body.light-mode .border-emerald-400 { border-color: #34d399 !important; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            #sidebar { width: 100% !important; height: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 1rem; flex-direction: column; }
            #sidebar.collapsed .sidebar-link-text, #sidebar.collapsed h2 .sidebar-title-text { opacity: 1; max-width: 150px; }
            #sidebar.collapsed ul li a { justify-content: flex-start; padding: 0.75rem 1rem; }
            #sidebar.collapsed ul li a i { margin-right: 0.75rem; }
            .sidebar-header { margin-bottom: 1rem; }
            #sidebar h2 .sidebar-title-text { font-size: 1.25rem; }
            #sidebarToggleBtn { display: none; }
            #sidebar ul { display: flex; justify-content: space-around; flex-wrap: wrap; overflow-y: visible; }
            #sidebar ul li a { padding: 0.5rem 0.75rem; margin-bottom: 0.25rem; }
            #main-content { padding: 1rem; }
            .kanban-column { margin: 0.5rem 0; }
            #kanbanBoardContainer { flex-direction: column; }
            .studio-textarea { min-height: 150px; }
            .search-input { margin-bottom: 1rem; }
            .stat-card-value { font-size: 2rem; }
            .follow-up-item { flex-direction: column; align-items: flex-start; }
            .follow-up-item-date { margin-top: 0.25rem; }
        }

        /* --- Improved CSS for markdown output (moved outside media query) --- */
        .studio-feedback-output-text, .research-output-container {
            font-size: 1.08rem;
            line-height: 1.8;
            padding: 1.5em;
        }
        .studio-feedback-output-text h1, .studio-feedback-output-text h2, .studio-feedback-output-text h3, .studio-feedback-output-text h4,
        .research-output-container h1, .research-output-container h2, .research-output-container h3, .research-output-container h4 {
            color: #60a5fa; /* blue-400 */
            margin-top: 1.2em;
            margin-bottom: 0.5em;
            font-weight: bold;
            letter-spacing: 0.01em;
        }
        .studio-feedback-output-text ul, .studio-feedback-output-text ol,
        .research-output-container ul, .research-output-container ol {
            margin-left: 1.5em;
            margin-bottom: 1em;
        }
        .studio-feedback-output-text ul li, .research-output-container ul li {
            list-style-type: disc;
            color: #38bdf8; /* sky-400 */
            margin-bottom: 0.3em;
            padding-left: 0.2em;
        }
        .studio-feedback-output-text ol li, .research-output-container ol li {
            list-style-type: decimal;
            color: #38bdf8;
            margin-bottom: 0.3em;
            padding-left: 0.2em;
        }
        .studio-feedback-output-text table, .research-output-container table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1em;
            background: #23293a;
            color: #e2e8f0;
        }
        .studio-feedback-output-text th, .studio-feedback-output-text td,
        .research-output-container th, .research-output-container td {
            border: 1px solid #60a5fa;
            padding: 0.5em;
        }
        .studio-feedback-output-text strong, .research-output-container strong {
            color: #fbbf24;
        }
        .studio-feedback-output-text blockquote, .research-output-container blockquote {
            border-left: 4px solid #60a5fa;
            margin: 1em 0;
            padding: 0.5em 1em;
            background: #1e293b;
            color: #cbd5e1;
        }
        .studio-feedback-output-text code, .research-output-container code {
            background: #23293a;
            color: #fbbf24;
            padding: 0.2em 0.4em;
            border-radius: 0.2em;
        }
        body.light-mode .studio-feedback-output-text h1, body.light-mode .studio-feedback-output-text h2, body.light-mode .studio-feedback-output-text h3, body.light-mode .studio-feedback-output-text h4,
        body.light-mode .research-output-container h1, body.light-mode .research-output-container h2, body.light-mode .research-output-container h3, body.light-mode .research-output-container h4 {
            color: #2563eb; /* blue-600 */
        }
        body.light-mode .studio-feedback-output-text ul li, body.light-mode .research-output-container ul li,
        body.light-mode .studio-feedback-output-text ol li, body.light-mode .research-output-container ol li {
            color: #0ea5e9; /* sky-500 */
        }
        body.light-mode .studio-feedback-output-text table, body.light-mode .research-output-container table {
            background: #f3f4f6;
            color: #1e293b;
        }
        body.light-mode .studio-feedback-output-text th, body.light-mode .studio-feedback-output-text td,
        body.light-mode .research-output-container th, body.light-mode .research-output-container td {
            border: 1px solid #2563eb;
        }
        body.light-mode .studio-feedback-output-text blockquote, body.light-mode .research-output-container blockquote {
            background: #e0e7ef;
            color: #1e293b;
            border-left: 4px solid #2563eb;
        }
        body.light-mode .studio-feedback-output-text code, body.light-mode .research-output-container code {
            background: #e0e7ef;
            color: #b45309;
        }
    </style>
</head>
<body>
    <aside id="sidebar">
        <div class="sidebar-header">
            <h2 class="flex items-center overflow-hidden"> <i class="fas fa-briefcase"></i>
                <span class="sidebar-title-text ml-2">Job Tracker</span>
            </h2>
            <button id="sidebarToggleBtn" title="Toggle Sidebar">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        <ul>
            <li><a data-page="kanbanBoardPage" class="active"><i class="fas fa-columns"></i><span class="sidebar-link-text">Kanban Board</span></a></li>
            <li><a data-page="tailoringStudioPage"><i class="fas fa-edit"></i><span class="sidebar-link-text">Tailoring Studio</span></a></li>
            <li><a data-page="dashboardPage"><i class="fas fa-tachometer-alt"></i><span class="sidebar-link-text">Dashboard</span></a></li>
            <li><a data-page="analyticsPage"><i class="fas fa-chart-line"></i><span class="sidebar-link-text">Analytics</span></a></li>
            <li><a data-page="settingsPage"><i class="fas fa-cog"></i><span class="sidebar-link-text">Settings</span></a></li>
        </ul>
    </aside>

    <div id="main-content">
        <div id="kanbanBoardPage" class="page-section active">
            <header class="mb-6 text-center md:text-left">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-100">My Job Applications</h1>
                <button id="addJobBtn" class="mt-3 btn-primary">
                    <i class="fas fa-plus mr-2"></i>Add New Job
                </button>
            </header>
            <div class="mb-6">
                <input type="text" id="kanbanSearchInput" class="search-input p-3" placeholder="Search by Job Title or Company...">
            </div>
            <div id="kanbanBoardContainer" class="flex flex-row justify-start space-x-0 md:space-x-4 overflow-x-auto pb-4 flex-grow"></div>
        </div>

        <div id="tailoringStudioPage" class="page-section">
            <header class="mb-6">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-100">Tailoring Studio</h1>
            </header>
            <div id="jobSelectionContainer" class="mb-6 studio-section">
                <label for="jobSelectDropdown" class="block text-lg font-medium mb-2 text-gray-300">Select Job Application to Tailor:</label>
                <select id="jobSelectDropdown" class="page-select">
                    <option value="">-- Select a Job --</option>
                </select>
            </div>
            <div id="tailoringSectionsContainer" class="hidden">
                <div class="studio-section">
                    <div class="field-header">
                        <label for="studioJdInput">Job Description</label>
                        <button type="button" class="btn-clear" onclick="document.getElementById('studioJdInput').value=''">Clear</button>
                    </div>
                    <textarea id="studioJdInput" class="w-full studio-textarea" placeholder="Paste the full job description here..."></textarea>
                </div>
                <div class="studio-section">
                    <div class="field-header">
                         <label for="studioResumeInput">Your Resume</label>
                         <button type="button" class="btn-clear" onclick="document.getElementById('studioResumeInput').value=''">Clear</button>
                    </div>
                    <textarea id="studioResumeInput" class="w-full studio-textarea" placeholder="Paste your relevant resume section or full resume..."></textarea>
                    <input type="text" id="studioResumeTagInput" class="modal-input mt-2 text-sm" placeholder="Optional: Resume Version/Tag">
                </div>
                <div class="studio-section">
                    <div class="field-header">
                        <label for="studioCoverLetterInput">Your Cover Letter</label>
                        <button type="button" class="btn-clear" onclick="document.getElementById('studioCoverLetterInput').value=''">Clear</button>
                    </div>
                    <textarea id="studioCoverLetterInput" class="w-full studio-textarea" placeholder="Paste your cover letter draft..."></textarea>
                    <input type="text" id="studioCoverLetterTagInput" class="modal-input mt-2 text-sm" placeholder="Optional: Cover Letter Version/Tag">
                </div>
                <div class="my-8 text-center">
                    <button id="studioGenerateFeedbackBtn" class="btn-primary py-3 px-6 text-lg">
                        <i class="fas fa-magic mr-2"></i>Generate Tailoring Suggestions
                    </button>
                </div>
                <div id="studioFeedbackOutputContainer" class="feedback-output-container hidden">
                    <h4><i class="fas fa-lightbulb mr-2"></i>Tailoring Feedback:</h4>
                    <div id="studioFeedbackOutputText" class="studio-feedback-output-text" style="font-size:1.05rem;line-height:1.7;font-family:inherit;white-space:normal;"></div>
                </div>
                <div class="studio-section mt-8">
                    <div class="field-header">
                        <label for="studioCompanyResearchInput">Company Research Notes</label>
                        <button type="button" class="btn-clear" onclick="document.getElementById('studioCompanyResearchInput').value=''; document.getElementById('studioResearchOutputContainer').classList.add('hidden');">Clear All</button>
                    </div>
                    <textarea id="studioCompanyResearchInput" class="w-full studio-textarea" placeholder="Add your company research notes here..."></textarea>
                    <div class="my-4 text-center">
                        <button id="studioGenerateResearchBtn" class="btn-secondary py-2 px-4">
                            <i class="fas fa-file-alt mr-2"></i>Generate Sample Research
                        </button>
                    </div>
                    <div id="studioResearchOutputContainer" class="research-output-container hidden">
                        <h4><i class="fas fa-building mr-2"></i>Sample Company Research:</h4>
                        <div id="studioResearchOutputText"></div>
                        <div id="researchDebugContainer" style="margin-top:1.5em; display:none;">
                            <button id="toggleDebugBtn" class="btn-secondary mb-3">Show/Hide Debug Info</button>
                            <div style="font-size:0.95em; background:#23293a; color:#cbd5e1; border-radius:0.3em; padding:1em; margin-bottom:1em;">
                                <strong>Tavily Search Result:</strong>
                                <pre id="tavilySearchDebug" style="white-space:pre-wrap; word-break:break-all;"></pre>
                            </div>
                            <div style="font-size:0.95em; background:#23293a; color:#cbd5e1; border-radius:0.3em; padding:1em; margin-bottom:1em;">
                                <strong>Tavily Extract Result:</strong>
                                <pre id="tavilyExtractDebug" style="white-space:pre-wrap; word-break:break-all;"></pre>
                            </div>
                            <div style="font-size:0.95em; background:#23293a; color:#cbd5e1; border-radius:0.3em; padding:1em; margin-bottom:1em;">
                                <strong>Gemini Prompt:</strong>
                                <pre id="geminiPromptDebug" style="white-space:pre-wrap; word-break:break-all;"></pre>
                            </div>
                            <div style="font-size:0.95em; background:#23293a; color:#cbd5e1; border-radius:0.3em; padding:1em;">
                                <strong>Gemini Response (Raw):</strong>
                                <pre id="geminiResponseDebug" style="white-space:pre-wrap; word-break:break-all;"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboardPage" class="page-section">
            <header class="mb-6">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-100">Dashboard</h1>
            </header>

            <div class="dashboard-section">
                <h2 class="text-xl font-semibold mb-4 text-gray-100 border-b border-gray-600 pb-2">Application Pipeline Overview</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                    <div class="stat-card"> <div id="statTotalActive" class="stat-card-value">0</div> <div class="stat-card-label">Total Active</div> </div>
                    <div class="stat-card"> <div id="statToApply" class="stat-card-value">0</div> <div class="stat-card-label">To Apply</div> </div>
                    <div class="stat-card"> <div id="statApplied" class="stat-card-value">0</div> <div class="stat-card-label">Applied</div> </div>
                    <div class="stat-card"> <div id="statFollowUp" class="stat-card-value">0</div> <div class="stat-card-label">Follow-Up</div> </div>
                    <div class="stat-card"> <div id="statInterview" class="stat-card-value">0</div> <div class="stat-card-label">Interview</div> </div>
                </div>
            </div>

            <div class="dashboard-section mt-8">
                <h2 class="text-xl font-semibold mb-4 text-gray-100 border-b border-gray-600 pb-2">Upcoming Follow-ups</h2>
                <ul id="dashboardFollowUpList" class="follow-up-list">
                    </ul>
            </div>

            <div class="dashboard-section mt-8">
                 <h2 class="text-xl font-semibold mb-4 text-gray-100 border-b border-gray-600 pb-2">More Insights Coming Soon...</h2>
                 <p class="text-gray-400">Activity metrics and more will be displayed here.</p>
            </div>
        </div>

        <div id="analyticsPage" class="page-section"><h1 class="text-3xl">Analytics (Coming Soon)</h1></div>
        
        <div id="settingsPage" class="page-section">
            <header class="mb-6">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-100">Settings</h1>
            </header>
            <div class="settings-section llm-config-section mb-8">
                <h3 class="text-xl font-semibold mb-4 text-gray-100 border-b border-gray-600 pb-2">LLM Configuration for Tailoring</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="llmProviderSelect">Tailoring Suggestions Provider:</label>
                        <select id="llmProviderSelect" class="page-select">
                            <option value="ollama">Ollama (Local)</option>
                            <option value="gemini">Google Gemini API</option>
                        </select>
                    </div>
                    <div id="geminiApiKeyContainer" class="hidden">
                        <label for="geminiApiKeyInput">Google Gemini API Key:</label>
                        <input type="password" id="geminiApiKeyInput" class="config-input" placeholder="Enter your Gemini API Key">
                        <p class="text-xs text-gray-400 mt-1">API key is stored locally in your browser.</p>
                    </div>
                    <div>
                        <label for="tavilyApiKeyInput">Tavily API Key:</label>
                        <input type="password" id="tavilyApiKeyInput" class="config-input" placeholder="Enter your Tavily API Key">
                        <p class="text-xs text-gray-400 mt-1">API key is stored locally in your browser.</p>
                    </div>
                    <div>
                        <label for="themeSelect">Theme:</label>
                        <select id="themeSelect" class="page-select">
                            <option value="dark">Dark</option>
                            <option value="light">Light</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                     <div id="ollamaConfigContainer">
                        <label for="ollamaApiEndpointInput">Ollama API Endpoint:</label>
                        <input type="text" id="ollamaApiEndpointInput" class="config-input" placeholder="e.g., http://localhost:11434/api/generate">
                        <label for="ollamaModelSelect" class="mt-2">Ollama Model Name:</label>
                        <select id="ollamaModelSelect" class="config-input">
                            <option value="llama3">llama3</option>
                            <option value="deepseek-r1:8b">deepseek-r1:8b</option>
                            <option value="gemma3:4b">gemma3:4b</option>
                            <option value="other">Other...</option>
                        </select>
                        <input type="text" id="ollamaModelNameInput" class="config-input mt-2" placeholder="Enter custom model name" style="display:none;">
                    </div>
                </div>
                 <button id="saveLlmConfigBtn" class="btn-secondary mt-6 py-2 px-4 text-base">Save LLM Configuration</button>
            </div>
            <div class="settings-section">
                 <h3 class="text-xl font-semibold mb-4 text-gray-100 border-b border-gray-600 pb-2">Application Preferences</h3>
                 <p class="text-gray-400">More settings coming soon...</p>
            </div>
        </div>
    </div>

    <div id="jobModal" class="fixed inset-0 z-50 items-center justify-center p-4 hidden modal">
        <div class="modal-content p-6 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <h2 id="modalTitle" class="text-2xl font-semibold mb-6">Add New Job</h2>
            <form id="jobForm">
                <input type="hidden" id="jobId">
                <div class="mb-4"> <label for="jobTitle" class="block text-sm font-medium mb-1">Job Title</label> <input type="text" id="jobTitle" class="modal-input" required> </div>
                <div class="mb-4"> <label for="company" class="block text-sm font-medium mb-1">Company</label> <input type="text" id="company" class="modal-input" required> </div>
                <div class="mb-4"> <label for="jobDescriptionLink" class="block text-sm font-medium mb-1">Job Description Link</label> <input type="url" id="jobDescriptionLink" class="modal-input" placeholder="https://..."> </div>
                <div class="mb-4"> <label for="resumeLink" class="block text-sm font-medium mb-1">Resume Link</label> <input type="url" id="resumeLink" class="modal-input" placeholder="https://..."> </div>
                <div class="mb-4"> <label for="coverLetterLink" class="block text-sm font-medium mb-1">Cover Letter Link</label> <input type="url" id="coverLetterLink" class="modal-input" placeholder="https://..."> </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div> <label for="applicationDate" class="block text-sm font-medium mb-1">Application Date</label> <input type="date" id="applicationDate" class="modal-input"> </div>
                    <div> <label for="followUpDate" class="block text-sm font-medium mb-1">Follow-Up Date</label> <input type="date" id="followUpDate" class="modal-input"> </div>
                </div>
                <div class="mb-4"> <label for="status" class="block text-sm font-medium mb-1">Status</label> <select id="status" class="modal-select"> </select> </div>
                <div class="mb-6"> <label for="notes" class="block text-sm font-medium mb-1">Notes</label> <textarea id="notes" rows="4" class="modal-textarea"></textarea> </div>
                <div class="flex justify-end space-x-3"> <button type="button" id="cancelBtn" class="btn-secondary">Cancel</button> <button type="submit" class="btn-primary">Save Job</button> </div>
            </form>
        </div>
    </div>

    <script>
        // --- Application State & Configuration ---
        const KANBAN_COLUMNS = ["To Apply", "Applied", "Follow-Up", "Interview", "Rejected", "Offer"];
        const ACTIVE_STAGES = ["To Apply", "Applied", "Follow-Up", "Interview"];
        let jobApplications = [];
        let draggedItem = null;
        const SIDEBAR_COLLAPSED_KEY = 'sidebarCollapsed';
        let currentStudioJobId = null;
        const LLM_PROVIDER_KEY = 'llmProvider';
        const GEMINI_API_KEY_KEY = 'geminiApiKey';
        const OLLAMA_ENDPOINT_KEY = 'ollamaApiEndpoint';
        const OLLAMA_MODEL_KEY = 'ollamaModelName';
        const TAVILY_API_KEY_KEY = 'tavilyApiKey';

        // --- DOM Elements ---
        const sidebar = document.getElementById('sidebar');
        const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
        const sidebarLinks = document.querySelectorAll('#sidebar ul li a');
        const pageSections = document.querySelectorAll('.page-section');
        const kanbanBoardContainer = document.getElementById('kanbanBoardContainer');
        const addJobBtn = document.getElementById('addJobBtn');
        const kanbanSearchInput = document.getElementById('kanbanSearchInput');
        const jobModal = document.getElementById('jobModal');
        const modalTitle = document.getElementById('modalTitle');
        const jobForm = document.getElementById('jobForm');
        const cancelBtn = document.getElementById('cancelBtn');
        const jobIdInput = document.getElementById('jobId');
        const jobTitleInput = document.getElementById('jobTitle');
        const companyInput = document.getElementById('company');
        const jobDescriptionLinkInput = document.getElementById('jobDescriptionLink');
        const resumeLinkInput = document.getElementById('resumeLink');
        const coverLetterLinkInput = document.getElementById('coverLetterLink');
        const applicationDateInput = document.getElementById('applicationDate');
        const followUpDateInput = document.getElementById('followUpDate');
        const statusInput = document.getElementById('status');
        const notesInput = document.getElementById('notes');
        const jobSelectDropdown = document.getElementById('jobSelectDropdown');
        const tailoringSectionsContainer = document.getElementById('tailoringSectionsContainer');
        const studioJdInput = document.getElementById('studioJdInput');
        const studioResumeInput = document.getElementById('studioResumeInput');
        const studioResumeTagInput = document.getElementById('studioResumeTagInput');
        const studioCoverLetterInput = document.getElementById('studioCoverLetterInput');
        const studioCoverLetterTagInput = document.getElementById('studioCoverLetterTagInput');
        const studioGenerateFeedbackBtn = document.getElementById('studioGenerateFeedbackBtn');
        const studioFeedbackOutputContainer = document.getElementById('studioFeedbackOutputContainer');
        const studioFeedbackOutputText = document.getElementById('studioFeedbackOutputText');
        const studioCompanyResearchInput = document.getElementById('studioCompanyResearchInput');
        const studioGenerateResearchBtn = document.getElementById('studioGenerateResearchBtn');
        const studioResearchOutputContainer = document.getElementById('studioResearchOutputContainer');
        const studioResearchOutputText = document.getElementById('studioResearchOutputText');
        const llmProviderSelect = document.getElementById('llmProviderSelect');
        const geminiApiKeyContainer = document.getElementById('geminiApiKeyContainer');
        const geminiApiKeyInput = document.getElementById('geminiApiKeyInput');
        const ollamaConfigContainer = document.getElementById('ollamaConfigContainer');
        const ollamaApiEndpointInput = document.getElementById('ollamaApiEndpointInput');
        const ollamaModelSelect = document.getElementById('ollamaModelSelect');
        const ollamaModelNameInput = document.getElementById('ollamaModelNameInput');
        const saveLlmConfigBtn = document.getElementById('saveLlmConfigBtn');
        const statTotalActive = document.getElementById('statTotalActive');
        const statToApply = document.getElementById('statToApply');
        const statApplied = document.getElementById('statApplied');
        const statFollowUp = document.getElementById('statFollowUp');
        const statInterview = document.getElementById('statInterview');
        const dashboardFollowUpList = document.getElementById('dashboardFollowUpList'); // New element for follow-ups
        const themeSelect = document.getElementById('themeSelect');
        const THEME_KEY = 'themeMode';
        const tavilyApiKeyInput = document.getElementById('tavilyApiKeyInput');
        const researchDebugContainer = document.getElementById('researchDebugContainer');
        const toggleDebugBtn = document.getElementById('toggleDebugBtn');
        const tavilySearchDebug = document.getElementById('tavilySearchDebug');
        const tavilyExtractDebug = document.getElementById('tavilyExtractDebug');
        const geminiPromptDebug = document.getElementById('geminiPromptDebug');
        const geminiResponseDebug = document.getElementById('geminiResponseDebug');

        // --- Utility Functions ---
        const generateId = () => '_' + Math.random().toString(36).substr(2, 9);
        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            const date = new Date(dateString + 'T00:00:00'); // Ensure it's treated as local date
            return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
        };

        // --- Page Navigation ---
        function switchPage(pageId) {
            pageSections.forEach(section => section.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            if (targetPage) targetPage.classList.add('active');

            sidebarLinks.forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === pageId) link.classList.add('active');
            });

            if (pageId === 'kanbanBoardPage') {
                if(kanbanSearchInput) kanbanSearchInput.value = '';
                renderKanbanBoard();
            } else if (pageId === 'tailoringStudioPage') {
                populateJobSelectDropdown();
                if (!currentStudioJobId || !jobApplications.find(job => job.id === currentStudioJobId)) {
                    resetTailoringStudio();
                }
            } else if (pageId === 'settingsPage') {
                loadLlmConfig(); 
                updateLlmConfigUI();
            } else if (pageId === 'dashboardPage') {
                renderDashboardPage(); // Combined dashboard rendering
            }
        }

        // --- Sidebar Toggle ---
        function toggleSidebar() {
            sidebar.classList.toggle('collapsed');
            localStorage.setItem(SIDEBAR_COLLAPSED_KEY, sidebar.classList.contains('collapsed'));
        }
        function setInitialSidebarState() {
            if (localStorage.getItem(SIDEBAR_COLLAPSED_KEY) === 'true' && window.innerWidth > 768) {
                sidebar.classList.add('collapsed');
            }
        }

        // --- LLM Configuration ---
        function loadLlmConfig() {
            if (llmProviderSelect) llmProviderSelect.value = localStorage.getItem(LLM_PROVIDER_KEY) || 'ollama';
            if (geminiApiKeyInput) geminiApiKeyInput.value = localStorage.getItem(GEMINI_API_KEY_KEY) || '';
            if (ollamaApiEndpointInput) ollamaApiEndpointInput.value = localStorage.getItem(OLLAMA_ENDPOINT_KEY) || 'http://localhost:11434/api/generate';
            if (ollamaModelSelect && ollamaModelNameInput) {
                const savedModel = localStorage.getItem(OLLAMA_MODEL_KEY) || 'llama3';
                if (["llama3","deepseek-r1:8b","gemma3:4b"].includes(savedModel)) {
                    ollamaModelSelect.value = savedModel;
                    ollamaModelNameInput.style.display = 'none';
                } else {
                    ollamaModelSelect.value = 'other';
                    ollamaModelNameInput.value = savedModel;
                    ollamaModelNameInput.style.display = '';
                }
            }
            if (tavilyApiKeyInput) tavilyApiKeyInput.value = localStorage.getItem(TAVILY_API_KEY_KEY) || '';
            updateLlmConfigUI();
        }
        function saveLlmConfig() {
            if (llmProviderSelect && geminiApiKeyInput && ollamaApiEndpointInput && ollamaModelSelect && ollamaModelNameInput) {
                localStorage.setItem(LLM_PROVIDER_KEY, llmProviderSelect.value);
                localStorage.setItem(GEMINI_API_KEY_KEY, geminiApiKeyInput.value.trim());
                localStorage.setItem(OLLAMA_ENDPOINT_KEY, ollamaApiEndpointInput.value.trim());
                if (ollamaModelSelect.value === 'other') {
                    localStorage.setItem(OLLAMA_MODEL_KEY, ollamaModelNameInput.value.trim());
                } else {
                    localStorage.setItem(OLLAMA_MODEL_KEY, ollamaModelSelect.value);
                }
                if (tavilyApiKeyInput) localStorage.setItem(TAVILY_API_KEY_KEY, tavilyApiKeyInput.value.trim());
                alert("LLM configuration saved!");
                updateLlmConfigUI();
            } else { console.error("LLM Config elements not found on current page. Cannot save."); }
        }
        function updateLlmConfigUI() {
            if (llmProviderSelect && geminiApiKeyContainer && ollamaConfigContainer) {
                geminiApiKeyContainer.classList.toggle('hidden', llmProviderSelect.value !== 'gemini');
                ollamaConfigContainer.classList.toggle('hidden', llmProviderSelect.value === 'gemini');
            }
        }

        // --- Local Storage (Jobs) ---
        function loadJobsFromLocalStorage() {
            const storedJobs = localStorage.getItem('jobApplications');
            if (storedJobs) jobApplications = JSON.parse(storedJobs);
            else {
                jobApplications = [
                    { id: generateId(), jobTitle: "AI Product Manager", company: "Innovatech AI", applicationDate: "2025-05-01", followUpDate: "2025-05-15", status: "To Apply", notes: "Focus on AI/ML product experience." },
                    { id: generateId(), jobTitle: "Senior Data Analyst", company: "Data Insights Corp", applicationDate: "2025-04-20", followUpDate: "2025-05-25", status: "Applied", notes: "Emphasize Python and SQL skills." },
                    { id: generateId(), jobTitle: "Frontend Developer", company: "Web Solutions LLC", applicationDate: "2025-05-05", followUpDate: "2025-05-12", status: "Interview", notes: "Technical interview next week." },
                    { id: generateId(), jobTitle: "UX Researcher", company: "UserFirst Ltd.", applicationDate: "2025-05-10", followUpDate: "", status: "Applied", notes: "Portfolio sent." }
                ];
            }
        }
        function saveJobsToLocalStorage() {
            localStorage.setItem('jobApplications', JSON.stringify(jobApplications));
        }

        // --- Job Modal (Kanban) ---
        function openJobModal(jobData = null) {
            jobForm.reset();
            statusInput.innerHTML = KANBAN_COLUMNS.map(col => `<option value="${col}">${col}</option>`).join('');
            if (jobData) {
                modalTitle.textContent = 'Edit Job Application';
                jobIdInput.value = jobData.id;
                jobTitleInput.value = jobData.jobTitle;
                companyInput.value = jobData.company;
                jobDescriptionLinkInput.value = jobData.jobDescriptionLink || '';
                resumeLinkInput.value = jobData.resumeLink || '';
                coverLetterLinkInput.value = jobData.coverLetterLink || '';
                applicationDateInput.value = jobData.applicationDate || '';
                followUpDateInput.value = jobData.followUpDate || '';
                statusInput.value = jobData.status;
                notesInput.value = jobData.notes || '';
            } else {
                modalTitle.textContent = 'Add New Job Application';
                jobIdInput.value = '';
                if (KANBAN_COLUMNS.length > 0) statusInput.value = KANBAN_COLUMNS[0];
            }
            jobModal.classList.remove('hidden');
            jobModal.classList.add('flex');
        }
        function closeJobModal() {
            jobModal.classList.add('hidden');
            jobModal.classList.remove('flex');
        }

        // --- Kanban Board Rendering ---
        // Color mapping for Kanban card borders
        const KANBAN_STATUS_COLORS = {
            "To Apply": "border-l-4 border-blue-400",
            "Applied": "border-l-4 border-indigo-400",
            "Follow-Up": "border-l-4 border-yellow-400",
            "Interview": "border-l-4 border-green-400",
            "Rejected": "border-l-4 border-red-400",
            "Offer": "border-l-4 border-emerald-400"
        };
        function renderKanbanBoard(searchTerm = "") {
            kanbanBoardContainer.innerHTML = '';
            const normalizedSearchTerm = searchTerm.toLowerCase().trim();
            let filteredJobs = jobApplications;
            if (normalizedSearchTerm) {
                filteredJobs = jobApplications.filter(job =>
                    job.jobTitle.toLowerCase().includes(normalizedSearchTerm) ||
                    job.company.toLowerCase().includes(normalizedSearchTerm)
                );
            }
            KANBAN_COLUMNS.forEach(columnName => {
                const columnDiv = document.createElement('div');
                columnDiv.classList.add('kanban-column', 'flex-shrink-0');
                columnDiv.dataset.status = columnName;
                const columnTitle = document.createElement('h3');
                columnTitle.classList.add('text-xl', 'font-semibold', 'mb-4', 'text-gray-100', 'border-b-2', 'border-gray-500', 'pb-2');
                const count = filteredJobs.filter(job => job.status === columnName).length;
                columnTitle.textContent = `${columnName} (${count})`;
                columnDiv.appendChild(columnTitle);
                const cardsContainer = document.createElement('div');
                cardsContainer.classList.add('space-y-4', 'h-full');
                const jobsInColumn = filteredJobs.filter(job => job.status === columnName);
                jobsInColumn.forEach(job => cardsContainer.appendChild(createJobCardElement(job)));
                columnDiv.appendChild(cardsContainer);
                kanbanBoardContainer.appendChild(columnDiv);
                columnDiv.addEventListener('dragover', handleDragOver);
                columnDiv.addEventListener('dragenter', handleDragEnter);
                columnDiv.addEventListener('dragleave', handleDragLeave);
                columnDiv.addEventListener('drop', handleDrop);
            });
        }
        function createJobCardElement(job) {
            const card = document.createElement('div');
            card.classList.add('kanban-card', 'shadow-lg');
            // Add color-coded border class based on status
            const borderClass = KANBAN_STATUS_COLORS[job.status] || '';
            if (borderClass) {
                borderClass.split(' ').forEach(cls => card.classList.add(cls));
            }
            card.setAttribute('draggable', true);
            card.dataset.id = job.id;

            // --- Optimization Indicator ---
            const missing = [];
            if (!job.resumeLink) missing.push('Resume');
            if (!job.coverLetterLink) missing.push('Cover Letter');
            if (!job.jobDescriptionLink) missing.push('Job Description');
            const indicatorDiv = document.createElement('div');
            indicatorDiv.style.position = 'absolute';
            indicatorDiv.style.top = '0.5rem';
            indicatorDiv.style.right = '0.75rem';
            indicatorDiv.style.zIndex = '2';
            indicatorDiv.style.display = 'flex';
            indicatorDiv.style.alignItems = 'center';
            let iconHtml = '';
            let tooltip = '';
            if (missing.length === 0) {
                iconHtml = '<i class="fa-solid fa-circle-check" style="color:#4ade80;font-size:1.2rem;text-shadow:0 1px 4px rgba(0,0,0,0.25);"></i>';
                tooltip = 'Fully tailored!';
            } else {
                iconHtml = '<i class="fa-solid fa-circle-info" style="color:#38bdf8;font-size:1.2rem;text-shadow:0 1px 4px rgba(0,0,0,0.25);"></i>';
                tooltip = 'Tip: Add ' + missing.join(', ') + ' to improve your chances!';
            }
            indicatorDiv.innerHTML = iconHtml;
            indicatorDiv.title = tooltip;
            card.style.position = 'relative';
            card.appendChild(indicatorDiv);

            const title = document.createElement('h4');
            title.classList.add('text-md', 'font-bold', 'mb-1', 'text-gray-100', 'truncate');
            title.textContent = job.jobTitle;
            card.appendChild(title);
            const company = document.createElement('p');
            company.classList.add('text-sm', 'text-gray-300', 'truncate');
            company.innerHTML = `<i class="fas fa-building mr-1 text-gray-400"></i> ${job.company}`;
            card.appendChild(company);
            const buttonsContainer = document.createElement('div');
            buttonsContainer.classList.add('mt-3', 'flex', 'justify-end', 'space-x-2');
            const editButton = document.createElement('button');
            editButton.innerHTML = '<i class="fas fa-edit"></i>';
            editButton.title = "Edit Application";
            editButton.classList.add('text-xs', 'text-blue-300', 'hover:text-blue-100', 'py-1', 'px-2', 'rounded');
            editButton.onclick = (e) => { e.stopPropagation(); openJobModal(job); };
            buttonsContainer.appendChild(editButton);
            const deleteButton = document.createElement('button');
            deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
            deleteButton.title = "Delete Application";
            deleteButton.classList.add('text-xs', 'text-red-400', 'hover:text-red-200', 'py-1', 'px-2', 'rounded');
            deleteButton.onclick = (e) => { e.stopPropagation(); deleteJob(job.id); };
            buttonsContainer.appendChild(deleteButton);
            card.appendChild(buttonsContainer);
            card.addEventListener('click', (e) => { if (!e.target.closest('button')) openJobModal(job); });
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);
            return card;
        }
        
        // --- Dashboard Rendering ---
        function renderDashboardPage() {
            renderDashboardPipelineOverview();
            renderDashboardFollowUps();
        }

        function renderDashboardPipelineOverview() {
            if (!statTotalActive) return; 

            let totalActiveCount = 0;
            const stageCounts = { "To Apply": 0, "Applied": 0, "Follow-Up": 0, "Interview": 0 };

            jobApplications.forEach(job => {
                if (ACTIVE_STAGES.includes(job.status)) {
                    totalActiveCount++;
                    if (stageCounts.hasOwnProperty(job.status)) stageCounts[job.status]++;
                }
            });

            statTotalActive.textContent = totalActiveCount;
            statToApply.textContent = stageCounts["To Apply"];
            statApplied.textContent = stageCounts["Applied"];
            statFollowUp.textContent = stageCounts["Follow-Up"];
            statInterview.textContent = stageCounts["Interview"];
        }

        function renderDashboardFollowUps() {
            if (!dashboardFollowUpList) return;
            dashboardFollowUpList.innerHTML = ''; // Clear previous items

            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize today to midnight for date comparisons

            const upcomingFollowUps = jobApplications
                .filter(job => job.followUpDate && ACTIVE_STAGES.includes(job.status)) // Only active jobs with a follow-up date
                .map(job => ({ ...job, followUpDateObj: new Date(job.followUpDate + 'T00:00:00') })) // Add a Date object for sorting
                .filter(job => job.followUpDateObj >= today || // Upcoming or today
                               (today.getTime() - job.followUpDateObj.getTime()) / (1000 * 3600 * 24) <= 7 ) // Or overdue by max 7 days
                .sort((a, b) => a.followUpDateObj - b.followUpDateObj);

            const maxFollowUpsToShow = 5;
            const followUpsToShow = upcomingFollowUps.slice(0, maxFollowUpsToShow);

            if (followUpsToShow.length === 0) {
                const li = document.createElement('li');
                li.classList.add('text-gray-400', 'italic', 'p-2', 'text-center');
                li.textContent = 'No upcoming follow-ups scheduled.';
                dashboardFollowUpList.appendChild(li);
                return;
            }

            followUpsToShow.forEach(job => {
                const li = document.createElement('li');
                li.classList.add('follow-up-item');

                const infoDiv = document.createElement('div');
                infoDiv.classList.add('follow-up-item-info');

                const titleDiv = document.createElement('div');
                titleDiv.classList.add('title');
                titleDiv.textContent = job.jobTitle;
                infoDiv.appendChild(titleDiv);

                const companyDiv = document.createElement('div');
                companyDiv.classList.add('company');
                companyDiv.textContent = job.company;
                infoDiv.appendChild(companyDiv);

                li.appendChild(infoDiv);

                const dateDiv = document.createElement('div');
                dateDiv.classList.add('follow-up-item-date');
                dateDiv.textContent = formatDate(job.followUpDate);

                // Style date if overdue or today
                if (job.followUpDateObj < today) {
                    dateDiv.classList.add('overdue');
                    dateDiv.textContent += ' (Overdue)';
                } else if (job.followUpDateObj.getTime() === today.getTime()) {
                    dateDiv.classList.add('today');
                    dateDiv.textContent += ' (Today)';
                }

                li.appendChild(dateDiv);
                dashboardFollowUpList.appendChild(li);
            });
        }


        // --- Tailoring Studio ---
        function populateJobSelectDropdown() {
            if (!jobSelectDropdown) return;
            jobSelectDropdown.innerHTML = '<option value="">-- Select a Job --</option>';
            jobApplications.forEach(job => {
                const option = document.createElement('option');
                option.value = job.id;
                option.textContent = `${job.jobTitle} at ${job.company}`;
                if (job.id === currentStudioJobId) option.selected = true;
                jobSelectDropdown.appendChild(option);
            });
        }
        function handleJobSelectionChange(event) {
            currentStudioJobId = event.target.value;
            if (currentStudioJobId) {
                tailoringSectionsContainer.classList.remove('hidden');
                studioJdInput.value = ''; 
                studioResumeInput.value = '';
                studioResumeTagInput.value = '';
                studioCoverLetterInput.value = '';
                studioCoverLetterTagInput.value = '';
                studioCompanyResearchInput.value = '';
                studioFeedbackOutputContainer.classList.add('hidden');
                studioFeedbackOutputText.textContent = '';
            } else {
                resetTailoringStudio();
            }
        }
        function resetTailoringStudio() {
            currentStudioJobId = null;
            if (jobSelectDropdown) jobSelectDropdown.value = "";
            if (tailoringSectionsContainer) tailoringSectionsContainer.classList.add('hidden');
            ['studioJdInput', 'studioResumeInput', 'studioResumeTagInput', 'studioCoverLetterInput', 'studioCoverLetterTagInput', 'studioCompanyResearchInput', 'studioFeedbackOutputText', 'studioResearchOutputText'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            ['studioFeedbackOutputContainer', 'studioResearchOutputContainer'].forEach(id => {
                 const el = document.getElementById(id);
                 if (el) el.classList.add('hidden');
            });
        }

        async function handleStudioGenerateFeedback() {
            if (!currentStudioJobId) { alert("Please select a job first."); return; }
            const jd = studioJdInput.value.trim();
            const resume = studioResumeInput.value.trim();
            const coverLetter = studioCoverLetterInput.value.trim();
            if (!jd || !resume) { alert("Please paste the Job Description and your Resume."); return; }
            studioFeedbackOutputText.textContent = "Generating suggestions, please wait...";
            studioFeedbackOutputContainer.classList.remove('hidden');
            studioFeedbackOutputContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            const provider = localStorage.getItem(LLM_PROVIDER_KEY) || 'ollama';
            let suggestions = "";
            const prompt = `Analyze the following Job Description, Resume, and Cover Letter. Provide specific, actionable suggestions to tailor the resume and cover letter to better match the Job Description. Focus on identifying skill gaps, keywords, and areas where the applicant can better highlight their experience relevant to the role. Job Description: --- ${jd} --- Resume: --- ${resume} --- Cover Letter (if provided): --- ${coverLetter || "No cover letter provided."} --- Suggestions:`;
            try {
                if (provider === 'ollama') {
                    const endpoint = localStorage.getItem(OLLAMA_ENDPOINT_KEY) || 'http://localhost:11434/api/generate';
                    const modelName = localStorage.getItem(OLLAMA_MODEL_KEY) || 'llama3';
                    if (!endpoint) { throw new Error("Ollama API endpoint is not configured in Settings."); }
                    const response = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ model: modelName, prompt: prompt, stream: false }) });
                    if (!response.ok) throw new Error(`Ollama API error: ${response.status} ${response.statusText}`);
                    const data = await response.json();
                    suggestions = data.response || "No suggestion received from Ollama.";
                } else if (provider === 'gemini') {
                    const apiKey = localStorage.getItem(GEMINI_API_KEY_KEY) || '';
                    if (!apiKey) { throw new Error("Gemini API Key is not configured in Settings."); }
                    const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(geminiApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                    if (!response.ok) { const errorData = await response.json(); console.error("Gemini API Error:", errorData); throw new Error(`Gemini API error: ${response.status} ${response.statusText} - ${errorData.error?.message || 'Unknown error'}`); }
                    const data = await response.json();
                    if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) { suggestions = data.candidates[0].content.parts[0].text; }
                    else { suggestions = "No suggestion received or unexpected format from Gemini."; console.warn("Gemini response format unexpected:", data); }
                }
                // Use marked.js for markdown rendering
                studioFeedbackOutputText.innerHTML = marked.parse(suggestions.trim());
            } catch (error) { console.error("Error generating feedback:", error); studioFeedbackOutputText.textContent = `Error: ${error.message}. Please check your LLM configuration in Settings and network.`; }
        }
        async function handleStudioGenerateResearch() {
            if (!currentStudioJobId) { alert("Please select a job first."); return; }
            const selectedJob = jobApplications.find(job => job.id === currentStudioJobId);
            if (!selectedJob) return;
            const tavilyApiKey = localStorage.getItem(TAVILY_API_KEY_KEY) || '';
            const geminiApiKey = localStorage.getItem(GEMINI_API_KEY_KEY) || '';
            // Clear debug info
            if (tavilySearchDebug) tavilySearchDebug.textContent = '';
            if (tavilyExtractDebug) tavilyExtractDebug.textContent = '';
            if (geminiPromptDebug) geminiPromptDebug.textContent = '';
            if (geminiResponseDebug) geminiResponseDebug.textContent = '';
            if (researchDebugContainer) researchDebugContainer.style.display = 'none';
            if (tavilyApiKey && geminiApiKey) {
                studioResearchOutputText.innerHTML = '<em>Fetching company research from Tavily, please wait...</em>';
                studioResearchOutputContainer.classList.remove('hidden');
                studioResearchOutputContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                try {
                    // Step 1: Tavily Multi-Query Search (Best Practices)
                    const subQueries = [
                        `${selectedJob.company} company overview`,
                        `${selectedJob.company} products and services`,
                        `${selectedJob.company} leadership team`,
                        `${selectedJob.company} financials`,
                        `${selectedJob.company} competitors`,
                        `${selectedJob.company} recent news`
                    ];
                    let allResults = [];
                    let allUrls = [];
                    let searchDebugArr = [];
                    for (const q of subQueries) {
                        const searchRes = await fetch('https://api.tavily.com/search', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + tavilyApiKey
                            },
                            body: JSON.stringify({
                                query: q,
                                search_depth: 'advanced',
                                max_results: 5,
                                chunks_per_source: 3,
                                include_raw_content: false
                            })
                        });
                        if (!searchRes.ok) throw new Error('Tavily Search error: ' + searchRes.status + ' ' + searchRes.statusText);
                        const searchData = await searchRes.json();
                        searchDebugArr.push({query: q, results: searchData.results});
                        if (searchData.results) {
                            allResults.push(...searchData.results);
                        }
                    }
                    if (tavilySearchDebug) tavilySearchDebug.textContent = JSON.stringify(searchDebugArr, null, 2);
                    // Filter by score > 0.5, deduplicate URLs
                    allUrls = allResults.filter(r => r.score > 0.5 && r.url).map(r => r.url);
                    allUrls = [...new Set(allUrls)];
                    // Limit to 10 URLs and filter for valid URLs
                    allUrls = allUrls.filter(url => /^https?:\/\//.test(url)).slice(0, 10);
                    if (!allUrls.length) throw new Error('No valid URLs to extract.');
                    // Step 2: Tavily Extract (Best Practices)
                    studioResearchOutputText.innerHTML = '<em>Extracting content from sources...</em>';
                    const extractResponse = await fetch('https://api.tavily.com/extract', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + tavilyApiKey
                        },
                        body: JSON.stringify({
                            urls: allUrls,
                            extract_depth: 'advanced'
                        })
                    });
                    if (!extractResponse.ok) throw new Error('Tavily Extract error: ' + extractResponse.status + ' ' + extractResponse.statusText);
                    const extractData = await extractResponse.json();
                    if (tavilyExtractDebug) tavilyExtractDebug.textContent = JSON.stringify(extractData, null, 2);
                    const extracted = (extractData.results || []).map(res => ({
                        url: res.url,
                        title: res.title || res.url,
                        content: res.raw_content || res.content || ''
                    })).filter(res => res.content);
                    if (!extracted.length) throw new Error('No content extracted from sources.');
                    // Step 3: Gemini LLM
                    studioResearchOutputText.innerHTML = '<em>Generating detailed research report with Gemini...</em>';
                    const geminiPrompt = `Using the following web content and sources, write a detailed company research report for ${selectedJob.company}.

**Format the report using markdown:**
- Start with a short summary at the top.
- Use '##' for each main section heading.
- Use bullet points for all lists and sublists wherever appropriate (do not use plain text for lists).
- Use tables for structured data (if available).
- Bold section titles and key facts.

Sections to include:
- Company Overview
- Core Products and Services
- Leadership Team
- Target Market and Partnerships
- Business Model and Distribution
- Key Differentiators
- Industry Overview
- Competition
- Competitive Advantages and Challenges
- Financial Overview
- News
- References (with links)

Web Content:
${extracted.map(e => `Source: ${e.title}\nURL: ${e.url}\nContent: ${e.content.substring(0, 3000)}...`).join('\n\n')}

If information is missing, say so in the relevant section.`;
                    if (geminiPromptDebug) geminiPromptDebug.textContent = geminiPrompt;
                    const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
                    const geminiResponse = await fetch(geminiApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: geminiPrompt }] }] })
                    });
                    if (!geminiResponse.ok) {
                        const errorData = await geminiResponse.json();
                        throw new Error(`Gemini API error: ${geminiResponse.status} ${geminiResponse.statusText} - ${errorData.error?.message || 'Unknown error'}`);
                    }
                    const geminiData = await geminiResponse.json();
                    if (geminiResponseDebug) geminiResponseDebug.textContent = JSON.stringify(geminiData, null, 2);
                    let report = '';
                    if (geminiData.candidates && geminiData.candidates[0]?.content?.parts?.[0]?.text) {
                        report = geminiData.candidates[0].content.parts[0].text;
                    } else {
                        report = 'No report received or unexpected format from Gemini.';
                    }
                    studioResearchOutputText.innerHTML = marked.parse(report.trim());
                    if (researchDebugContainer) researchDebugContainer.style.display = '';
                } catch (err) {
                    studioResearchOutputText.innerHTML = `<span style=\"color:#e53e3e;\">Error: ${err.message}</span>`;
                    if (researchDebugContainer) researchDebugContainer.style.display = '';
                }
                return;
            }
            // Fallback to static template if no API key(s)
            const sampleResearch = `## Company Overview: ${selectedJob.company}
**Mission:** [Simulated: To revolutionize the industry through innovative AI solutions that empower businesses and individuals.]
**Recent News & Developments:**
- Announced Series B funding of $XX million to expand R&D in generative AI. (Source: TechCrunch, [Date])
- Launched new product '[Product Name]' aimed at [Target Market], receiving positive early reviews for its [Key Feature]. (Source: Company Blog, [Date])
- Keynote speech by CEO at [Conference Name] highlighted focus on ethical AI development.
**Products/Services:**
- Core Product A: [Brief description and key benefits]
- Service B: [Brief description and target clients]
- New Initiative C: [Details about upcoming or recent projects]
**Culture & Values (from Glassdoor/Company Website):**
- Emphasis on collaboration and innovation.
- Fast-paced environment.
- Commitment to diversity and inclusion.
**Potential Talking Points/Alignment:**
- Your experience in [Relevant Skill/Project] aligns well with their recent launch of '[Product Name]'.
- The company's focus on [Specific Value/Mission Point] resonates with your career goals in [Your Goal].
- Question to ask: "I read about the recent Series B funding. How does the company plan to allocate these resources towards its AI roadmap, particularly in [Area of Interest]?"
**Key Competitors:**
- Competitor X
- Competitor Y
*(Disclaimer: This is simulated research data.)*`;
            studioResearchOutputText.innerHTML = marked.parse(sampleResearch.trim());
            studioResearchOutputContainer.classList.remove('hidden');
            studioResearchOutputContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // --- Drag and Drop (Kanban) ---
        function handleDragStart(event) { if (!event.target.classList.contains('kanban-card')) return; draggedItem = event.target; event.dataTransfer.setData('text/plain', event.target.dataset.id); event.dataTransfer.effectAllowed = 'move'; setTimeout(() => { event.target.classList.add('dragging'); }, 0); }
        function handleDragEnd(event) { if (draggedItem) { draggedItem.classList.remove('dragging'); } draggedItem = null; document.querySelectorAll('.kanban-column').forEach(col => col.classList.remove('drag-over-column')); }
        function handleDragOver(event) { event.preventDefault(); if (event.target.closest('.kanban-column')) { event.dataTransfer.dropEffect = 'move'; } else { event.dataTransfer.dropEffect = 'none'; } }
        function handleDragEnter(event) { event.preventDefault(); const column = event.target.closest('.kanban-column'); if (column && draggedItem) { column.classList.add('drag-over-column'); } }
        function handleDragLeave(event) { const column = event.target.closest('.kanban-column'); if (column) { if (!column.contains(event.relatedTarget)) { column.classList.remove('drag-over-column'); } } else if (event.target.classList && event.target.classList.contains('kanban-column')) { event.target.classList.remove('drag-over-column'); } }
        function handleDrop(event) { event.preventDefault(); const targetColumnElement = event.target.closest('.kanban-column'); if (targetColumnElement && draggedItem) { const jobId = draggedItem.dataset.id; const newStatus = targetColumnElement.dataset.status; const jobIndex = jobApplications.findIndex(j => j.id === jobId); if (jobIndex !== -1) { jobApplications[jobIndex].status = newStatus; saveJobsToLocalStorage(); renderKanbanBoard(kanbanSearchInput.value); if (currentStudioJobId === jobId) { populateJobSelectDropdown(); } } } if (targetColumnElement) { targetColumnElement.classList.remove('drag-over-column'); } }

        // --- CRUD Operations (Jobs) ---
        function handleJobFormSubmit(event) {
            event.preventDefault();
            const id = jobIdInput.value;
            const jobData = {
                jobTitle: jobTitleInput.value.trim(), company: companyInput.value.trim(),
                jobDescriptionLink: jobDescriptionLinkInput.value.trim(), resumeLink: resumeLinkInput.value.trim(),
                coverLetterLink: coverLetterLinkInput.value.trim(), applicationDate: applicationDateInput.value,
                followUpDate: followUpDateInput.value, status: statusInput.value, notes: notesInput.value.trim()
            };
            if (!jobData.jobTitle || !jobData.company) { alert("Job Title and Company are required."); return; }
            if (id) { const jobIndex = jobApplications.findIndex(j => j.id === id); if (jobIndex !== -1) { jobApplications[jobIndex] = { ...jobApplications[jobIndex], ...jobData }; }
            } else { jobData.id = generateId(); jobApplications.push(jobData); }
            saveJobsToLocalStorage(); renderKanbanBoard(kanbanSearchInput.value); closeJobModal();
            populateJobSelectDropdown();
        }
        function deleteJob(jobId) {
            if (confirm("Are you sure you want to delete this job application? This action cannot be undone.")) {
                jobApplications = jobApplications.filter(job => job.id !== jobId);
                saveJobsToLocalStorage(); renderKanbanBoard(kanbanSearchInput.value);
                if (jobId === currentStudioJobId) { resetTailoringStudio(); }
                populateJobSelectDropdown();
            }
        }

        // --- Event Listeners ---
        if (sidebarToggleBtn) sidebarToggleBtn.addEventListener('click', toggleSidebar);
        sidebarLinks.forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); switchPage(link.dataset.page); }));
        addJobBtn.addEventListener('click', () => openJobModal());
        if (kanbanSearchInput) kanbanSearchInput.addEventListener('input', (e) => renderKanbanBoard(e.target.value));
        cancelBtn.addEventListener('click', closeJobModal);
        jobForm.addEventListener('submit', handleJobFormSubmit);
        jobModal.addEventListener('click', (event) => { if (event.target === jobModal) closeJobModal(); });
        if (llmProviderSelect) llmProviderSelect.addEventListener('change', updateLlmConfigUI);
        if (saveLlmConfigBtn) saveLlmConfigBtn.addEventListener('click', saveLlmConfig);
        if (jobSelectDropdown) jobSelectDropdown.addEventListener('change', handleJobSelectionChange);
        if (studioGenerateFeedbackBtn) studioGenerateFeedbackBtn.addEventListener('click', handleStudioGenerateFeedback);
        if (studioGenerateResearchBtn) studioGenerateResearchBtn.addEventListener('click', handleStudioGenerateResearch);
        if (themeSelect) {
            themeSelect.addEventListener('change', function() {
                setTheme(themeSelect.value);
            });
        }
        if (ollamaModelSelect && ollamaModelNameInput) {
            ollamaModelSelect.addEventListener('change', function() {
                if (ollamaModelSelect.value === 'other') {
                    ollamaModelNameInput.style.display = '';
                } else {
                    ollamaModelNameInput.style.display = 'none';
                }
            });
        }
        if (toggleDebugBtn && researchDebugContainer) {
            toggleDebugBtn.addEventListener('click', function() {
                const debugDivs = researchDebugContainer.querySelectorAll('div,pre');
                researchDebugContainer.style.display = researchDebugContainer.style.display === 'none' ? '' : 'none';
            });
        }

        window.addEventListener('resize', () => {
            if (window.innerWidth <= 768 && sidebar.classList.contains('collapsed')) {}
            else if (window.innerWidth > 768) { setInitialSidebarState(); }
        });

        // --- Initialization ---
        function initializeApp() {
            setInitialSidebarState();
            loadJobsFromLocalStorage(); 
            loadLlmConfig(); 
            renderKanbanBoard(); 
            switchPage('kanbanBoardPage'); 
        }
        function setTheme(mode) {
            if (mode === 'light') {
                document.body.classList.add('light-mode');
                if (themeSelect) themeSelect.value = 'light';
            } else {
                document.body.classList.remove('light-mode');
                if (themeSelect) themeSelect.value = 'dark';
            }
            localStorage.setItem(THEME_KEY, mode);
        }
        function setInitialTheme() {
            const saved = localStorage.getItem(THEME_KEY);
            if (themeSelect) {
                if (saved === 'light') {
                    setTheme('light');
                    themeSelect.value = 'light';
                } else {
                    setTheme('dark');
                    themeSelect.value = 'dark';
                }
            } else {
                if (saved === 'light') setTheme('light');
                else setTheme('dark');
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
            setInitialTheme();
            initializeApp();
        });
    </script>
</body>
</html>
